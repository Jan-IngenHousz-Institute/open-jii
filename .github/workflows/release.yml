name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      affected_apps: ${{ steps.detect.outputs.affected_apps }}
      has_affected_apps: ${{ steps.detect.outputs.has_affected_apps }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for semantic versioning
          
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-nodejs-pnpm
        with:
          node-version: "22"
          
      - name: Detect Affected Packages
        id: detect
        uses: ./.github/actions/detect-affected-packages

  build:
    name: Build Affected Apps
    needs: detect
    if: needs.detect.outputs.has_affected_apps == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-nodejs-pnpm
        with:
          node-version: "22"
          
      - name: Build Packages
        uses: ./.github/actions/build-packages
        with:
          affected_apps: ${{ needs.detect.outputs.affected_apps }}

  release:
    name: Create Releases
    needs: [detect, build]
    if: needs.detect.outputs.has_affected_apps == 'true'
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.semantic_release.outputs.releases_created }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
          
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-nodejs-pnpm
        with:
          node-version: "22"
          
      - name: Create Semantic Releases
        id: semantic_release
        uses: ./.github/actions/semantic-release
        with:
          affected_apps: ${{ needs.detect.outputs.affected_apps }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry_run: 'false'
      
      - name: Release Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          RELEASES='${{ steps.semantic_release.outputs.releases_created }}'
          if [ "$RELEASES" = "{}" ]; then
            echo "No new releases created." >> $GITHUB_STEP_SUMMARY
          else
            echo "The following releases were created:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$RELEASES" | jq -r 'to_entries | .[] | "- **\(.key)**: v\(.value) (tag: `\(.key)-v\(.value)`)"' >> $GITHUB_STEP_SUMMARY
          fi

  # Mobile deployment job (triggered when mobile is released)
  deploy-mobile:
    name: Deploy Mobile
    needs: release
    if: contains(needs.release.outputs.releases_created, 'mobile')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Release Metadata
        uses: actions/download-artifact@v4
        with:
          name: release-metadata
      
      - name: Parse Mobile Release Info
        id: mobile_release
        run: |
          if [ -f "release-summary-mobile.json" ]; then
            VERSION=$(jq -r '.version' release-summary-mobile.json)
            TAG=$(jq -r '.tag' release-summary-mobile.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Mobile release: $TAG"
          fi
      
      - name: Log Deployment Info
        run: |
          echo "ðŸš€ Mobile app released!"
          echo "Version: ${{ steps.mobile_release.outputs.version }}"
          echo "Tag: ${{ steps.mobile_release.outputs.tag }}"
          # echo ""
          # echo "ðŸ“‹ Next steps:"
          # echo "  1. Connect this job to your EAS build workflow"
          # echo "  2. Build AAB/APK with the released version"
          # echo "  3. Upload to Play Store/App Store"
          # echo ""
          # echo "ðŸ”— Documentation: https://docs.openjii.org/deployment/mobile"

  # Web deployment job (triggered when web is released)
  deploy-web:
    name: Deploy Web
    needs: release
    if: contains(needs.release.outputs.releases_created, 'web')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Release Metadata
        uses: actions/download-artifact@v4
        with:
          name: release-metadata
      
      - name: Parse Web Release Info
        id: web_release
        run: |
          if [ -f "release-summary-web.json" ]; then
            VERSION=$(jq -r '.version' release-summary-web.json)
            TAG=$(jq -r '.tag' release-summary-web.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Web release: $TAG"
          fi
      
      - name: Log Deployment Info
        run: |
          echo "ðŸš€ Web app released!"
          echo "Version: ${{ steps.web_release.outputs.version }}"
          echo "Tag: ${{ steps.web_release.outputs.tag }}"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Connect this job to your web deployment workflow"
          echo "  2. Deploy to production environment"
          echo ""
          echo "ðŸ”— Production: https://openjii.org"
          echo "ðŸ”— Documentation: https://docs.openjii.org/deployment/web"

  # Backend deployment job (triggered when backend is released)
  deploy-backend:
    name: Deploy Backend
    needs: release
    if: contains(needs.release.outputs.releases_created, 'backend')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Release Metadata
        uses: actions/download-artifact@v4
        with:
          name: release-metadata
      
      - name: Parse Backend Release Info
        id: backend_release
        run: |
          if [ -f "release-summary-backend.json" ]; then
            VERSION=$(jq -r '.version' release-summary-backend.json)
            TAG=$(jq -r '.tag' release-summary-backend.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Backend release: $TAG"
          fi
      
      - name: Log Deployment Info
        run: |
          echo "ðŸš€ Backend released!"
          echo "Version: ${{ steps.backend_release.outputs.version }}"
          echo "Tag: ${{ steps.backend_release.outputs.tag }}"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Connect this job to your backend deployment workflow"
          echo "  2. Deploy to ECS/Lambda"
          echo ""
          echo "ðŸ”— API: https://api.openjii.org"
          echo "ðŸ”— Documentation: https://docs.openjii.org/deployment/backend"

  # Docs deployment job (triggered when docs is released)
  deploy-docs:
    name: Deploy Docs
    needs: release
    if: contains(needs.release.outputs.releases_created, 'docs')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Release Metadata
        uses: actions/download-artifact@v4
        with:
          name: release-metadata
      
      - name: Parse Docs Release Info
        id: docs_release
        run: |
          if [ -f "release-summary-docs.json" ]; then
            VERSION=$(jq -r '.version' release-summary-docs.json)
            TAG=$(jq -r '.tag' release-summary-docs.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "âœ… Docs release: $TAG"
          fi
      
      - name: Log Deployment Info
        run: |
          echo "ðŸš€ Docs released!"
          echo "Version: ${{ steps.docs_release.outputs.version }}"
          echo "Tag: ${{ steps.docs_release.outputs.tag }}"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Connect this job to your docs deployment workflow"
          echo "  2. Build and deploy Docusaurus site"
          echo ""
          echo "ðŸ”— Documentation: https://docs.openjii.org"