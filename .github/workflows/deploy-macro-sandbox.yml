# Macro Sandbox Deployment Workflow
# Builds 3 Docker images (Python, JS, R) and deploys to Lambda

name: Macro Sandbox Deployment Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "The deployment environment (dev, staging, prod)"
        required: true
        type: string
      ref:
        description: "Git ref (commit SHA, branch, or tag) to deploy - leave empty to deploy current branch latest commit"
        required: false
        type: string
        default: ""
  workflow_call:
    inputs:
      environment:
        description: "The deployment environment (dev, staging, prod)"
        required: true
        type: string
      ref:
        description: "Git ref (commit SHA, branch, or tag) to deploy - leave empty to deploy current branch latest commit"
        required: false
        type: string
        default: ""

env:
  ENV: ${{ inputs.environment }}

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy Macro Sandbox
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: python
            dockerfile: functions/python/Dockerfile
            ecr_repo: macro-sandbox-python
            function_name: macro-sandbox-python
          - language: javascript
            dockerfile: functions/javascript/Dockerfile
            ecr_repo: macro-sandbox-js
            function_name: macro-sandbox-js
          - language: r
            dockerfile: functions/r/Dockerfile
            ecr_repo: macro-sandbox-r
            function_name: macro-sandbox-r

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref || github.sha }}

      - name: Get Checked Out SHA
        id: get-sha
        run: |
          ACTUAL_SHA=$(git rev-parse HEAD)
          echo "sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT
          echo "Checked out SHA: $ACTUAL_SHA"

      - name: Capture Deployment Start Time
        id: deployment-start
        run: |
          DEPLOY_START=$(date +%s)
          echo "DEPLOY_START_TIME=$DEPLOY_START" >> $GITHUB_ENV
          echo "deploy_start_time=$DEPLOY_START" >> $GITHUB_OUTPUT

          COMMIT_TIME=$(git show -s --format=%ct)
          echo "COMMIT_TIME=$COMMIT_TIME" >> $GITHUB_ENV
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT

          echo "üìä DORA Metrics Collection Started"
          echo "  Language: ${{ matrix.language }}"
          echo "  Commit SHA: $ACTUAL_SHA"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set environment variables
        run: |
          echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ steps.get-sha.outputs.sha }}" >> $GITHUB_ENV
          echo "ECR_REPO=${{ matrix.ecr_repo }}-${{ env.ENV }}" >> $GITHUB_ENV
          echo "FUNCTION_NAME=${{ matrix.function_name }}-${{ env.ENV }}" >> $GITHUB_ENV

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        working-directory: apps/macro-sandbox
        run: |
          set -euo pipefail

          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

          echo "üî® Building ${{ matrix.language }} macro-sandbox..."
          docker build \
            -f ${{ matrix.dockerfile }} \
            -t "${FULL_IMAGE}" \
            --platform linux/amd64 \
            .

          echo "üì¶ Pushing ${FULL_IMAGE}..."
          docker push "${FULL_IMAGE}"

          echo "image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "‚úÖ Image pushed: ${FULL_IMAGE}"

      - name: Update Lambda function code
        id: update-lambda
        run: |
          set -euo pipefail

          echo "üöÄ Updating Lambda function: ${FUNCTION_NAME}"
          aws lambda update-function-code \
            --function-name "${FUNCTION_NAME}" \
            --image-uri "${{ steps.build-image.outputs.image }}" \
            --output json > /dev/null

          echo "‚è≥ Waiting for function update to complete..."
          aws lambda wait function-updated-v2 \
            --function-name "${FUNCTION_NAME}"

          echo "‚úÖ Lambda function updated: ${FUNCTION_NAME}"

      - name: Verify deployment
        run: |
          set -euo pipefail

          CURRENT_IMAGE=$(aws lambda get-function-configuration \
            --function-name "${FUNCTION_NAME}" \
            --query "CodeSha256" \
            --output text)

          echo "üîç Function: ${FUNCTION_NAME}"
          echo "   Code SHA: ${CURRENT_IMAGE}"
          echo "   Image: ${{ steps.build-image.outputs.image }}"

      - name: Calculate DORA Metrics
        id: dora-metrics
        if: always()
        run: |
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START_TIME))
          LEAD_TIME=$((DEPLOY_END - COMMIT_TIME))
          LEAD_TIME_MS=$((LEAD_TIME * 1000))

          echo "lead_time_ms=$LEAD_TIME_MS" >> $GITHUB_OUTPUT
          echo "deployment_duration=$DEPLOY_DURATION" >> $GITHUB_OUTPUT

          echo "üìä DORA Metrics (${{ matrix.language }}):"
          echo "  Lead Time: ${LEAD_TIME}s"
          echo "  Deployment Duration: ${DEPLOY_DURATION}s"

      - name: Publish DORA - Deployment Frequency
        if: always()
        uses: ./.github/actions/publish-dora-metric
        with:
          metric-name: "DeploymentFrequency"
          value: "1"
          unit: "Count"
          service: "macro-sandbox-${{ matrix.language }}"
          environment: ${{ env.ENV }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish DORA - Lead Time
        if: always()
        uses: ./.github/actions/publish-dora-metric
        with:
          metric-name: "LeadTime"
          value: ${{ steps.dora-metrics.outputs.lead_time_ms }}
          unit: "Milliseconds"
          service: "macro-sandbox-${{ matrix.language }}"
          environment: ${{ env.ENV }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish DORA - Deployment Success
        if: always()
        uses: ./.github/actions/publish-dora-metric
        with:
          metric-name: "DeploymentSuccess"
          value: "1"
          unit: "Count"
          service: "macro-sandbox-${{ matrix.language }}"
          environment: ${{ env.ENV }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish DORA - Deployment Failed
        if: always()
        uses: ./.github/actions/publish-dora-metric
        with:
          metric-name: "DeploymentFailed"
          value: "1"
          unit: "Count"
          service: "macro-sandbox-${{ matrix.language }}"
          environment: ${{ env.ENV }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "::group::=== ${{ matrix.language }} Deployment Summary ==="
          echo "Environment: ${{ env.ENV }}"
          echo "Function: ${FUNCTION_NAME}"
          echo "Image: ${{ steps.build-image.outputs.image }}"

          if [[ "${{ steps.update-lambda.outcome }}" == "success" ]]; then
            echo "‚úÖ ${{ matrix.language }} macro-sandbox deployed successfully"
          else
            echo "‚ùå ${{ matrix.language }} macro-sandbox deployment failed"
          fi
          echo "::endgroup::"
