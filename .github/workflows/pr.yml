name: PR Workflow

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened
  workflow_dispatch:


permissions:
  contents: read
  pull-requests: read

jobs:
  validate_pr:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_lint_test:
    name: Build, Lint, & Test
    runs-on: ubuntu-latest
    env:
      DO_NOT_TRACK: 1
      TURBO_TELEMETRY_DISABLED: 1
      environment: "dev"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-nodejs-pnpm
        with:
          node-version: "22"
      - name: Detect Affected Packages
        id: detect
        uses: ./.github/actions/detect-affected-packages

      - name: Build Packages
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: ./.github/actions/build-packages
        with:
          affected_apps: ${{ steps.detect.outputs.affected_apps }}

      - name: Lint Packages
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: ./.github/actions/lint-packages
        with:
          affected_apps: ${{ steps.detect.outputs.affected_apps }}

      - name: Test Packages
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: ./.github/actions/test-packages
        with:
          affected_apps: ${{ steps.detect.outputs.affected_apps }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          skip-coverage: ${{ github.actor == 'dependabot[bot]' }}

      - name: Save coverage artifacts for main branch upload
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.event.pull_request.head.sha }}
          path: |
            apps/*/coverage/lcov.info
            apps/*/coverage.json
          retention-days: 1

  preview_release:
    name: Preview Next Release Version
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for semantic versioning
      
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-nodejs-pnpm
        with:
          node-version: "22"
      
      - name: Detect Affected Packages
        id: detect
        uses: ./.github/actions/detect-affected-packages
      
      - name: Preview Release (Dry Run)
        id: preview
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: ./.github/actions/semantic-release
        with:
          affected_apps: ${{ steps.detect.outputs.affected_apps }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          dry_run: 'true'
      
      - name: Comment PR with Preview
        if: steps.detect.outputs.has_affected_apps == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releases = JSON.parse('${{ steps.preview.outputs.releases_created }}');
            
            let comment = '## üîç Release Preview\n\n';
            
            if (Object.keys(releases).length === 0) {
              comment += '‚úÖ **No new releases will be created.**\n\n';
              comment += 'The changes in this PR do not trigger a version bump (e.g., docs, chore, style commits).\n';
            } else {
              comment += '‚ú® Merging this PR will create the following releases:\n\n';
              
              for (const [app, version] of Object.entries(releases)) {
                comment += `### ${app}\n`;
                comment += `- **Version**: \`v${version}\`\n`;
                comment += `- **Tag**: \`${app}-v${version}\`\n`;
                comment += `- **GitHub Release**: Will be created automatically\n`;
                comment += `- **Deployment**: Will trigger ${app} deployment workflow\n\n`;
              }
              
              comment += '---\n';
              comment += '### üìö What gets released?\n\n';
              comment += 'Releases are triggered by **conventional commits**:\n';
              comment += '- `feat:` ‚Üí Minor version bump (1.0.0 ‚Üí 1.1.0)\n';
              comment += '- `fix:` ‚Üí Patch version bump (1.0.0 ‚Üí 1.0.1)\n';
              comment += '- `BREAKING CHANGE:` ‚Üí Major version bump (1.0.0 ‚Üí 2.0.0)\n';
              comment += '- `docs:`, `chore:`, `style:` ‚Üí No release\n\n';
              comment += 'üìñ [Release Documentation](https://docs.openjii.org/releases)\n';
            }
            
            comment += '\n---\n';
            comment += '*This is a preview based on your conventional commits. Actual releases will occur when merged to main.*';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîç Release Preview')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  tofu:
    name: OpenTofu
    needs: build_lint_test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, prod]
    environment: ${{ matrix.environment }}
    concurrency:
      group: opentofu-${{ matrix.environment }}
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
    env:
      environment: ${{ matrix.environment }}
      TF_VAR_databricks_account_id: ${{ secrets.DATABRICKS_ACCOUNT_ID }}
      TF_VAR_databricks_client_id: ${{ secrets.DATABRICKS_CLIENT_ID }}
      TF_VAR_databricks_client_secret: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
      TF_VAR_databricks_host: ${{ secrets.DATABRICKS_HOST }}
      TF_VAR_auth_secret: ${{ secrets.AUTH_SECRET }}
      TF_VAR_github_oauth_client_id: ${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
      TF_VAR_github_oauth_client_secret: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
      TF_VAR_backend_webhook_api_key_id: ${{ secrets.BACKEND_WEBHOOK_API_KEY_ID }}
      TF_VAR_backend_webhook_api_key: ${{ secrets.BACKEND_WEBHOOK_API_KEY }}
      TF_VAR_backend_webhook_secret: ${{ secrets.BACKEND_WEBHOOK_SECRET }}
      TF_VAR_backend_databricks_warehouse_id: ${{ secrets.BACKEND_DATABRICKS_WAREHOUSE_ID }}
      TF_VAR_contentful_space_id: ${{ secrets.CONTENTFUL_SPACE_ID }}
      TF_VAR_contentful_access_token: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
      TF_VAR_contentful_preview_access_token: ${{ secrets.CONTENTFUL_PREVIEW_ACCESS_TOKEN }}
      TF_VAR_contentful_preview_secret: ${{ secrets.CONTENTFUL_PREVIEW_SECRET }}
      TF_VAR_api_cloudfront_header_value: ${{ secrets.API_CLOUDFRONT_HEADER_VALUE }}
      TF_VAR_orcid_oauth_client_id: ${{ secrets.ORCID_OAUTH_CLIENT_ID }}
      TF_VAR_orcid_oauth_client_secret: ${{ secrets.ORCID_OAUTH_CLIENT_SECRET }}
      TF_VAR_posthog_key: ${{ secrets.POSTHOG_KEY }}
      TF_VAR_slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      TF_VAR_kinesis_credential_id: ${{ secrets.KINESIS_CREDENTIAL_ID }}
      TF_VAR_dev_nameservers: ${{ secrets.DEV_NAMESERVERS }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup OpenTofu and AWS Credentials
        uses: ./.github/actions/tofu/tofu-setup
        with:
          aws_role_arn: ${{ secrets.AWS_ROLE_ARN }}
          aws_region: ${{ secrets.AWS_REGION }}
          tofu_version: "1.9.0"

      - name: OpenTofu Format Check
        uses: ./.github/actions/tofu/tofu-fmt-check

      - name: OpenTofu Init and Validate
        uses: ./.github/actions/tofu/tofu-init-validate

      - name: OpenTofu Plan
        uses: ./.github/actions/tofu/tofu-plan
    

  approval_gate:
      name: Approval Gate
      needs: tofu
      runs-on: ubuntu-latest
      environment: approval-gate
      permissions:
        id-token: write
        contents: read
      steps:
        - name: Await Approval for Apply
          run: |
            echo "Waiting for approval to apply changes in the dev environment."

  apply:
    name: OpenTofu Apply
    needs: [tofu, approval_gate]
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout Repository
        run: | 
          echo "Test apply step"
